#!/bin/bash

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Git –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

set -e

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ GIT_FULL_URL
if [[ -z "${GIT_FULL_URL}" ]]; then
    echo "‚ö†Ô∏è  GIT_FULL_URL –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
    exit 0
fi

echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git –ø—Ä–æ–µ–∫—Ç–∞..."

# –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ URL
GIT_PROJECT_NAME="$(basename "$GIT_FULL_URL" .git)"

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤
mkdir -p /home/vagrant/projects
cd /home/vagrant/projects || exit 1

# –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç
if [ -d "${GIT_PROJECT_NAME}" ]; then
    echo "–ü—Ä–æ–µ–∫—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º..."
    cd "${GIT_PROJECT_NAME}" || exit 1
    git pull
else
    echo "–ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç: ${GIT_PROJECT_NAME}..."
    git clone "${GIT_FULL_URL}"
    cd "${GIT_PROJECT_NAME}" || exit 1
fi

echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω: /home/vagrant/projects/${GIT_PROJECT_NAME}"

# –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [[ -n "${INSTALL_SCRIPT}" ]] && [ -f "${INSTALL_SCRIPT}" ]; then
    echo ""
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞: ${INSTALL_SCRIPT}"
    echo "=================================================="
    
    # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
    chmod +x "${INSTALL_SCRIPT}"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç
    bash "${INSTALL_SCRIPT}"
    
    echo "=================================================="
    echo "‚úÖ –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω"
elif [ -f "install.sh" ]; then
    echo ""
    echo "üöÄ –ù–∞–π–¥–µ–Ω install.sh, –∑–∞–ø—É—Å–∫–∞–µ–º..."
    echo "=================================================="
    
    chmod +x install.sh
    bash install.sh
    
    echo "=================================================="
    echo "‚úÖ –°–∫—Ä–∏–ø—Ç install.sh –≤—ã–ø–æ–ª–Ω–µ–Ω"
else
    echo ""
    echo "‚ÑπÔ∏è  –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–µ —É–∫–∞–∑–∞–Ω INSTALL_SCRIPT –∏ –Ω–µ—Ç install.sh)"
fi

echo ""
echo "üìÇ –ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ: /home/vagrant/projects/${GIT_PROJECT_NAME}"
