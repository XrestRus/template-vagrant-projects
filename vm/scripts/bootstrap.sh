#!/bin/bash

# –ì–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ VM –ø–æ—Å–ª–µ –ø—Ä–æ–≤–∏–∂–∏–æ–Ω–∏–Ω–≥–∞

set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

echo "=================================================="
echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
echo "=================================================="

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ Windows -> Unix
echo ""
echo "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è CRLF -> LF)..."
sudo apt-get update -qq
sudo apt-get install -y dos2unix

# –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∏ env —Ñ–∞–π–ª—ã
find /vagrant/vm -type f -name "*.sh" -exec dos2unix {} \; 2>/dev/null || true
if [ -f /vagrant/vm/env ]; then
  dos2unix /vagrant/vm/env 2>/dev/null || true
fi

echo "‚úÖ –§–∞–π–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ vm/env
set -a
source /vagrant/vm/env
set +a

SCRIPTS_DIR="/vagrant/vm/scripts"

# 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo ""
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
sudo apt update

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
echo ""
echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
bash "${SCRIPTS_DIR}/install-base.sh"

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
echo ""
echo "üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Engine..."
bash "${SCRIPTS_DIR}/install-docker.sh"

# 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ LXC
echo ""
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ LXC —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º dnsmasq..."
bash "${SCRIPTS_DIR}/install-lxc.sh"

# 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH
echo ""
echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH —Å–µ—Ä–≤–µ—Ä–∞..."
bash "${SCRIPTS_DIR}/setup-ssh.sh"

# 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSHFS (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
if [[ -n "${SSHFS_URL}" ]]; then
    echo ""
    echo "üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSHFS –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
    bash "${SCRIPTS_DIR}/install-sshfs.sh"
else
    echo ""
    echo "‚ÑπÔ∏è  SSHFS_URL –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
fi

# 7. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤
if [ -d "/vagrant/configs" ]; then
    echo ""
    echo "‚öôÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π..."
    bash "${SCRIPTS_DIR}/apply-configs.sh"
fi

# 8. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
if [[ -n "${GIT_FULL_URL}" ]]; then
    echo ""
    echo "üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Git –ø—Ä–æ–µ–∫—Ç–∞..."
    bash "${SCRIPTS_DIR}/setup-project.sh"
else
    echo ""
    echo "‚ÑπÔ∏è  GIT_FULL_URL –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
fi

# 9. –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∫—ç—à–∏, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã)
echo ""
bash "${SCRIPTS_DIR}/cleanup.sh"

# 10. –§–∏–Ω–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
echo ""
echo "=================================================="
echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "=================================================="
echo ""
echo "üìå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
echo "  ‚Ä¢ Docker:  $(docker --version)"
echo "  ‚Ä¢ Compose: $(docker compose version)"
echo "  ‚Ä¢ LXC:     $(lxc-ls --version 2>/dev/null || echo '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
echo ""
echo "üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:"
echo "  ‚Ä¢ SSH: vagrant ssh"
echo "  ‚Ä¢ SOCKS5 –ø—Ä–æ–∫—Å–∏: vagrant ssh -- -D7777"
echo ""
echo "üìÇ –ü—Ä–æ–µ–∫—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤: /home/vagrant/projects/"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤ –≥—Ä—É–ø–ø—ã docker,"
echo "   –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑: vagrant ssh"
echo ""

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ shell –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø
exec /bin/bash
